<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Video Summarizer</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>

<body>
    <a href="/dashboard" class="dashboard-link">Dashboard</a>
    <div class="logo-container">
        <img class="logo" src="{{ url_for('static', path='images/logo.png') }}" alt="Logo">
    </div>

    <main>
        <h1>AI Video Summary Generator ðŸ¤–</h1>
        <h2>Automatically generate SOPs, Training Guides, Meeting Summaries, and more.</h2>

        <form id="summaryForm" action="#" autocomplete="on">

            <!-- File Upload -->
            <div>
                <label for="uploadFiles">Upload file(s)</label>
                <input id="uploadFiles" type="file" accept="video/*,image/*,application/*" multiple />

                <div style="margin-top:0.5rem">
                    <label for="uploadFolder">Or upload a folder</label>
                    <input id="uploadFolder" type="file" webkitdirectory directory multiple />
                </div>

                <p class="help">Tip: hold Ctrl/Cmd to select multiple files.</p>
            </div>

            <!-- Summary Type -->
            <div>
                <label for="summaryType">Summary Type</label>
                <select id="summaryType" required>
                    <option value="">Choose a type</option>
                    <option value="Sop">SOP</option>
                    <option value="TrainingGuide">Training Guide</option>
                    <option value="MeetingSummary">Meeting Summary</option>
                    <option value="CustomPrompt">Custom Prompt</option>
                </select>

                <div id="customPromptContainer" style="display:none; margin-top:1rem;">
                    <label for="customPrompt">Custom Prompt</label>
                    <textarea id="customPrompt" rows="7"></textarea>
                </div>
            </div>

            <!-- Audience Context -->
            <div>
                <label for="audienceContext">Audience Context (optional)</label>
                <textarea id="audienceContext" rows="7"
                    placeholder="Provide additional context for the summary"></textarea>
            </div>

            <!-- Summary Options -->
            <fieldset style="padding:1rem; border:1px solid #ccc; border-radius:5px;">
                <legend>Summary Options</legend>

                <div class="checkbox-container">
                    <div class="checkbox-group">
                        <input id="includeScreenshots" type="checkbox">
                        <label for="includeScreenshots">Include Screenshots</label>
                    </div>

                    <div>
                        <label for="outputFormat">Output Format</label>
                        <select id="outputFormat" required>
                            <option value="word">Word</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>

                    <div>
                        <label for="detailLevel">Detail Level</label>
                        <select id="detailLevel">
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                            <option value=5>5</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <div>
                <button type="submit">Submit</button>
            </div>

        </form>
    </main>

    <script>
        const summaryTypeEl = document.getElementById("summaryType");
        const customPromptContainer = document.getElementById("customPromptContainer");
        const customPromptEl = document.getElementById("customPrompt");
        
        // Checks that custom prompt is not empty
        summaryTypeEl.addEventListener("change", function() {
            if (this.value === "CustomPrompt") {
                customPromptContainer.style.display = "block";
                customPromptEl.required = true;
            } else {
                customPromptContainer.style.display = "none";
                customPromptEl.required = false;
            }
        });
        
        // Prevent form submission if neither a a file or folder was selected
        document.getElementById("summaryForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const fileInput = document.getElementById("uploadFiles");
            const folderInput = document.getElementById("uploadFolder");
            const files = [...fileInput.files, ...folderInput.files];

            if (files.length === 0) {
                alert("Please upload at least one file.");
                return;
            }

            const formData = {
                summaryType: summaryTypeEl.value,
                customPrompt: customPromptEl.value || null,
                audienceContext: document.getElementById("audienceContext").value || null,
                includeScreenshots: document.getElementById("includeScreenshots").checked,
                outputFormat: document.getElementById("outputFormat").value,
                detailLevel: parseInt(document.getElementById("detailLevel").value, 10) // base 10
            };
            
            try {
                
                // 1. Request signed URLs
                const signedRes = await fetch("/generate-signed-urls", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        files: files.map(f => ({
                            filename: f.name,
                            content_type: f.type || "application/octet-stream"
                        }))
                    })
                });

                if (!signedRes.ok) throw new Error("Failed to get signed URLs");

                const { files: signedFiles } = await signedRes.json();
                console.log(signedFiles)
                
                // 2. Upload each file with a PUT request
                await Promise.all(signedFiles.map((sf, idx) =>
                    fetch(sf.signed_url, {
                        method: "PUT",
                        body: files[idx],
                        headers: { "Content-Type": files[idx].type || "application/octet-stream" }
                    }).then(r => {
                        if (!r.ok) throw new Error(`Failed upload: ${files[idx].name}. Please try again.`);
                    })
                ));
          
                // 3. Submit formData with video IDs
                const submitRes = await fetch("/submit-form-data", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        video_ids: signedFiles.map(sf => sf.video_id),
                        ...formData
                    })
                });
                
                if (!submitRes.ok) throw new Error("Failed to submit form data!");

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        });
    </script>

    <!-- Implement short polling here for checking status of files -->

</body>
</html>
